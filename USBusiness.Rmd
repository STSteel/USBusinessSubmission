---
title: "USBusinessReport"
author: "Simone Trindade Steel"
date: "25/07/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## US Business Report: an analysis of economic sentiment and new housing construction

## 1. Introduction and executive summary

This reports is based on a study of business and industry trends in the United States 
using the US Census Bureau data available on https://www.kaggle.com/census/business-and-industry-reports.

The inspiration for this study is the hypothesis that US National level of value generation,
as an indication of economic optimism, drives the antecipation of new property demand. 

The analysis looks for regional variations in the US and attempts to predict the regional 
growth of new home construction and sales.

The main objective is to unveil whether or not there is an identifiable time lag between the perception of a buoyant economic environment and the offer of newly built houses on the market. Given that the construction sector does not have the same agility as other parts of the economy, such as retail and services, it could be important for investors, government agencies and policy makers to prevent over or under investment in the construction sector.

By identifying a time lag between stimulus and result, investment in construction could be self-regulated to avoid large oscillation in supply, which may contribute to distortions in the market, such as the so-called "housing bubbles".



```{r set-up, include=FALSE}
library(lubridate)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(tidytext)
library(caret)
library(data.table)
library(rpart)
library(randomForest)


options(digits = 3)    # 3 significant digits

getwd()
filename <- "CapstoneProject_data.csv"
metadata <- "CapstoneProject_metadata.csv"

# Loading time series data
temp <- read_file(filename)
data <-read_csv(temp, guess_max = 1000000)
df <- as.data.frame(data)
df <- df %>% mutate(value = as.numeric(value))


# Loading metadata to enable selection of Housing indicators and overall Financial results
temp <- read_file(metadata)
md <-read_csv(temp)
md_df <- as.data.frame(md)

```

## 2. Method and analysis 

## 2.1. Initial considerations

House construction is a relatively slow-moving activity. Securing funds, land and necessary permissions are traditionally extended processes. An important assumption in this analysis is that there is an interval between decision to build and houses becoming available, i.e. time lag. 

This report includes the analysis of several values for time lag, aiming to detect the interval that produces the best predictive capability for investment expansion and contraction trajectories. The time lag values chosen for this analysis will be based on a short Fibonacci sequence (1, 2, 3, 5, 8, 13 expressed and calendar years).

Another dimension of analysis is region within the United States. This is to verify the hypothesis that regional differences in dominant industries and variations in economic cycles lead to different behaviour towards real estate investment.

In summary:
a. This report uses the standard mechanism for randomly splitting the training and test sets using probability of 0.9 and 0.1, respectively.
b. The outcome of the prediction will be categorical: 1 representing above average housing offers for the region and 0 representing below average.
c. Overall accuracy was chosen as the best method for measuring success of the predictive model, i.e. maximising the proportion of correct predictions on the test set.  
d. The objectives are to identify (a) the time lag between economic indicators and housing offers and (b) the best performing predictive model or ensemble of models that maximises overall accuracy.

## 2.2. Understanding the data

The original dataset has many economic factors that will not be used in this study.

The time series that are relevant to the subject of this report are:
a. The macroeconomic indicators (named "Financial Reports") and 
b. The new housing indicators (named "New Home Sales", "New Residential Construction").

All dates indicate the begining of the analysis period, and they have been used to align the time series into quarterly periods - January, April, July and October.

The graphs below summarise the US national totals, and show the disruption created by the 2008 crisis. Following the crisis, revenue resumed its upwards trajectory, as seen with broader economic recovery. 

The analysis will also consider variations of revenue generation per industry, as these also exhibit geographic characteristics.

The regional graphs, however, show that new housing construction and offering vary along each individual regional average that appears not related to the broader revenue generation at national level.

In order to understand what drives an increase and decrease of new housing, this analysis will categorise above average new housing offers as 1, and below average as 0, relative to each regional average.

The structure and sample data below shows the relevant metadata used in this study. For ease of reference, the script is commented as "Understanding and preparing data" in the Report.R file.

```{r analysis, include=FALSE}
# What time series are used for new home sales and housing under construction indicators? 
housing_cat <- md_df %>% 
  filter((report=="New Residential Construction" | report=="New Home Sales"), 
         dt_code=="TOTAL",
         is_adj==0)
str(housing_cat)

# What time series are used for value creation in the financial reports (sales, revenue)? 
finance_cat <- md_df %>% 
  filter(report=="Quarterly Financial Report", 
         dt_code=="101",
         is_adj==0)
str(finance_cat)



# Loading the relevant time series for analysis

# All activity related to new dwellings, as a proxy for expected regional demand for housing
housing_dat <- df %>% filter(time_series_code %in% housing_cat$time_series_code)
head(housing_dat)

# All sales and revenue at national level, keeping all the aggregated numbers per industry (category_level=0)
finance_cat <- finance_cat %>% filter(category_level==0)
finance_dat <- df %>% filter(time_series_code %in% finance_cat$time_series_code)
# Separate industry category as a column
finance_dat <- finance_dat %>% mutate(industry = str_trunc(time_series_code, 3, side="right", ellipsis=""))
finance_dat <- finance_dat %>% mutate(industry = as.factor(industry))
head(finance_dat)

# Trimming the housing time series according to available financial data
housing_dat <- housing_dat %>% filter(date>=min(finance_dat$date) & date<=max(finance_dat$date))
min(housing_dat$date) == min(finance_dat$date)
max(housing_dat$date) == max(finance_dat$date)


# Aggregate quarterly for analysis alongside financial data
housing_dat <- housing_dat %>% 
  mutate(quarter = as_date(ifelse(month(date)==2 | month(date)==3,
                                               as_date(paste(as.character(year(date)),'01',as.character(day(date)), sep="-")),
                           ifelse(month(date)==5 | month(date)==6,
                                               as_date(paste(as.character(year(date)),'04',as.character(day(date)), sep="-")),
                           ifelse(month(date)==8 | month(date)==9,
                                               as_date(paste(as.character(year(date)),'07',as.character(day(date)), sep="-")),
                           ifelse(month(date)==11 | month(date)==12,
                                               as_date(paste(as.character(year(date)),'10',as.character(day(date)), sep="-")),
                                               date))))))

housing_dat %>% group_by(quarter) %>% summarise(n())

# Override date column for easier manipulation later
housing_dat <- housing_dat %>% mutate(date=quarter)

# Separate state and national levels
housing_dat <- housing_dat %>% mutate(region = str_trunc(time_series_code, 2, side="left", ellipsis=""))
housing_dat <- housing_dat %>% mutate(region = as.factor(region))
# Aggregating all new house activity
housing_dat <- housing_dat %>% group_by(date, region) %>% summarise(value=sum(value))
housing_dat_total <- data.frame(housing_dat)
str(housing_dat_total)

# Visualising the effects of National value generation on the antecipation of housing demand (i.e. new build) regionally.

```

```{r analysis-graphs, echo=FALSE}
# Firstly, the 2008 housing market shock is clearly visible in both the financial and housing data
graph_fin <- finance_dat %>% group_by(date) %>% summarise(value_generated=sum(value)) %>% 
  ggplot(aes(x=date, y=value_generated)) + 
  ylab("Sales and Revenue in USD Millions") +
  ggtitle("US total from Q4/2000 to Q1/2017") +
  geom_line() + geom_vline(xintercept=date("2008-09-15"), colour="red") +
  annotation_custom(grid::linesGrob())
graph_fin

avg <- housing_dat %>% ungroup() %>% filter(region=="US") %>% select(v=value) %>% summarise(mean(v))
graph_h_us <- housing_dat_total %>% filter(region=="US") %>% 
   group_by(region, date) %>% summarise(new_builds=sum(value)) %>% 
   ggplot(aes(x=date, y=new_builds)) + 
   ylab("Thousands of new housing units") +
   ggtitle("US total from Q4/2000 to Q1/2017") +
   geom_point() + geom_hline(yintercept=as.numeric(avg), colour="blue") +
   geom_vline(xintercept=date("2008-09-15"), colour="red")
graph_h_us

# Looking closer at each region, the volatility in the South is far greater than the other regions.
# The Northeast is stable relatively to the national income fluctuations.
graph_h_reg <- housing_dat_total %>% filter(region!="US") %>% 
  group_by(region, date) %>% summarise(new_builds=sum(value)) %>% 
  ggplot(aes(x=date, y=new_builds, colour=region)) + 
  ylab("Thousands of new housing units") +
  ggtitle("Total per region from Q4/2000 to Q1/2017") +
  geom_smooth() 
graph_h_reg


```


## 2.3. Preparing data for analysis

Several steps are performed here:

(1) Creating different time lag data and aligning them with income generation and house construction. As explained earlier, a short Fibonacci sequence is going to be used to explore different time lags: 1, 2, 3, 5, 8 and 13 years.

(2) Removing aggregated US National data points in order not to double count properties.

(3) Preparing regional averages, given that the variations are significant between regions.

(4) Introducing industry classification, given their regional variation.

Industry codes are:


```{r preparing-data, echo=FALSE}

# Industry codes and description
finance_cat %>% select(Code=cat_code, Description=cat_desc) %>% knitr::kable()

# Adding a time lag in years (1, 2, 3, 5, 8, 13) between sentiment of growth (sales, revenue) and new house activity

finance_dat <- finance_dat %>% mutate(lag_1y = as_date(paste(as.character(year(date)+1), as.character(month(date)),as.character(day(date)), sep="-")),
lag_2y = as_date(paste(as.character(year(date)+2), as.character(month(date)),as.character(day(date)), sep="-")),
lag_3y = as_date(paste(as.character(year(date)+3), as.character(month(date)),as.character(day(date)), sep="-")),
lag_5y = as_date(paste(as.character(year(date)+5), as.character(month(date)),as.character(day(date)), sep="-")),
lag_8y = as_date(paste(as.character(year(date)+8), as.character(month(date)),as.character(day(date)), sep="-")),
lag_13y = as_date(paste(as.character(year(date)+13), as.character(month(date)),as.character(day(date)), sep="-")))

# Matrix for prediction, aligning all values by quarter: achoring the year of housing offer and bringing in financial results according to time lag.
temp <- inner_join(housing_dat_total, finance_dat, by.x = "date", by.y = "lag_y1")
dataset <- temp %>% mutate(new_houses_K = value.x, national_income_MY1 = value.y) %>% 
                    dplyr::select(date, region, industry, new_houses_K, national_income_MY1)

dataset <- inner_join(dataset, finance_dat, by.x = "date", by.y = "lag_y2") %>% 
           mutate(new_houses_K = value.x, national_income_MY2 = value.y) 
           
### repeat for 3, 5, 8, 13           
### dplyr::select(date, region, industry, new_houses_K, national_income_MY1:MY13)


head(dataset)

# Removing US totals
# dataset <- dataset %>% filter(!is.na(national_income_M), region!="US")
dataset <- dataset %>% filter(region!="US")

# Pre 2008 (darker shades), construction was higher in the South and West regions.
# But over time, it seems negatively influenced by income, especially in the Mining industry
dataset %>% 
  ggplot(aes(x=log10(national_income_M), y=new_houses_K, colour=year(date))) + 
  xlab("Sales and Revenue in USD Millions (log10)") +
  ylab("New Housing in Thousands of Units") +
  ggtitle("Revenue and New Housing, per region and industry") +
  geom_point()  + 
  facet_grid(industry ~ region)

# This requires centreing the analysis on regional means

housing_avg <- dataset %>% group_by(region) %>% summarise(avg = mean(new_houses_K))
dataset <- inner_join(dataset, housing_avg, by="region")

# Trend = 1 meaning positive, if more new houses than average are predicted
# Trend = 0 meaning negative, if fewer new houses than average are predicted

dataset <- dataset %>% mutate(trend=as.factor(ifelse(new_houses_K>=avg,1,0)))
#head(dataset)

```


## 2.4. Making predictions and finding optimal time lag parameter

This report aims to demonstrate that the regional trends of new house construction is lagging 
the sentiment of a positive economic position, as observed by financial reports on sales, invoicing and revenue at the national level.

In order to do that, the concept of positive or negative trend was introduced. Positive trend means
that regional construction is above historical average, and negative trend means below average.

The models that appeared most appropriate for this exercise were GLM, KNN and Random Forest.

The ensemble of those models did not improve on the prediction made via Random Forest.

```{r prediction, include=FALSE}

# Splitting training and test datasets

# Validation set will be 50% of Housing data
set.seed(1, sample.kind="Rounding")

test_index <- createDataPartition(y = dataset$new_houses_K, times = 1, p = 0.5, list = FALSE)
train_ds <- dataset[-test_index[,1],]
test_ds <- dataset[test_index[,1],]



# Training 

# Selecting predictors (Training Set)
x <- train_ds %>% dplyr::select (date, region, industry, national_income_M, avg)
y <- train_ds$trend


# ============= GLM ==============
fit <- train(x, y, method = "glm")
fit$results
# Testing
y_hat_GLM <- predict(fit, test_ds) 
y_hat <- y_hat_GLM
acc <- confusionMatrix(data = y_hat, reference = test_ds$trend)$overall["Accuracy"]
res <- data.frame(model="GLM", acc=acc)


# ========= Random Forest ========
fit <- randomForest(y ~ ., data = x, nodesize = 50, maxnodes = 25)
fit$importance
# Testing
y_hat_RF <- predict(fit, test_ds) 
y_hat <- y_hat_RF
acc <- confusionMatrix(data = y_hat, reference = test_ds$trend)$overall["Accuracy"]
res <- rbind(res, data.frame(model="RF", acc=acc))

# ========= KNN ============

ks <- seq(1, 31, 3)
F_1 <- sapply(ks, function(k){
  fit <- knn3(y ~ ., data = x, k = k)
  y_hat <- predict(fit, test_ds, type = "class") %>% 
    factor(levels = levels(test_ds$trend))
  F_meas(data = y_hat, reference = test_ds$trend)
})
# plot(ks, F_1)
# max(F_1)
# ks[which.max(F_1)]
fit <- knn3(y ~ ., data = x, k = ks[which.max(F_1)])
y_hat_KNN <- predict(fit, test_ds, type = "class")
y_hat <- y_hat_KNN
acc <- confusionMatrix(data = y_hat, reference = test_ds$trend)$overall["Accuracy"]
res <- rbind(res, data.frame(model="KNN", acc=acc))


# ======= Ensemble ===========
# ENSEMBLE #
y_set <- data.frame(y_hat_GLM = as.integer(ifelse(y_hat_GLM==1, 1, 0)),
                    y_hat_KNN = as.integer(ifelse(y_hat_KNN==1, 1, 0)),
                    y_hat_RF = as.integer(ifelse(y_hat_RF==1, 1, 0)))

y_set <- y_set %>% mutate(ens_y_hat = round((y_hat_GLM + y_hat_KNN + y_hat_RF)/3))
                                               
y_set <- y_set %>% mutate(y_hat = as.factor(ens_y_hat))
levels(y_set$y_hat) <- levels(test_ds$trend)
#head(y_set)
acc <- confusionMatrix(y_set$y_hat, test_ds$trend)$overall["Accuracy"]
res <- rbind(res, data.frame(model="Ensemble", acc=acc))

```

```{r diplay-predictions, echo=FALSE}
res %>% select(Model=model, Accuracy=acc) %>% knitr::kable()

```

## 3. Results
Optimal Time lag
Comparison of predictive models
Ensemble result

## 4. Conclusion

This report shows that a predictive model can be used to determine the volume, relative to the regional average, of new houses that will be offered x years later based on the economic outlook of a particular region in the United States. This may have useful applications for investors and policy makers to prevent over and under investment, which can have damaging effects in the economy because of the illiquid nature of real estate assets.

There is a reasonably high predictive power of house construction by US Region based on the past year financial performance of each industry. The maximum accuracy obtained with the Random Forest model was y.

As with any macroeconomic analysis, the interdependencies and correlations between indicators are complex and were not fully explored in this report. However, future studies based on this approach could enrich the understanding between perception of prosperity and attitude towards real estate investment, such as tax structure changes and specific cyclical nature of each industry.
